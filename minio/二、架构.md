## 1.物理架构

## ![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652865505928-9b868c68-3163-48ce-9794-ff022e43d53b.png)

### 1. Driver （驱动器）

 	一个磁盘（disk）就是一个Driver（驱动器）

### 2. Erasure Set

所有用来存储数据的Driver（驱动器）的集合

### 3.  Server Pool （服务资源池）

一台服务器可以挂载多个硬盘。

多台服务器组成的一个对象存储服务称为Server Pool，即服务资源池。

下列命令可以启动一个由4个服务器（每个服务器2块磁盘）组成的Server Pool

```
minio server http://server:9000{1...4}/disk{1...2}
```

### 4、Cluster （集群）

一个Cluster集群可以包含一个或多个Server Pool （服务资源池）

下列命令可以将两个Server Pool组成一个Cluster（集群）

```
minio server http://server{1...4}:9000/disk{1...2} http://server{5...8}:9000/disk{1...2} 
```

MinIO不支持动态添加节点的方式扩容，只能通过增加Server Pool的方式扩容

## 2.Erasure Code 纠删码原理浅析

MinIO 通过纠删码实现数据冗余，纠删码相比于多副本，可以提高磁盘的空间利用率。

### 2.1.纠删码与副本比较

假设有一个100M的文件，存储到3个磁盘中，实现任意一个磁盘损坏不丢失数据。

- **副本方式**

将100M文件分割成part1，part2两个50M大小的文件，每个文件保存2份。实际占用200M的存储空间。

![副本存储](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652837189059-7910a0b1-ad68-4406-8959-676e609adbaa.png)

- **纠删码方式**

将100M文件分割成part1，part2两个50M大小的文件，通过纠删码算法对part1和part2两个进行计算，生成一个50M的校验块，当part1、part2任意一个损坏时，可以通过校验块逆向恢复文件。实际占用150M的存储空间。

![纠删码存储](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652837547903-881c63ec-8d9f-4616-8a73-b8126a1b5d4e.png)

### 2.2 纠删码数据恢复原理

纠删码（Erasure Codes）能够总体上分为XOR 码和RS 码两类，XOR 码编、解码只需要按位异或（bit-wise exclusive-OR）即可完成，速度较快；MinIO使用Reed-Solomon码生成数据校验块，具有更好磁盘利用率，但是需要更多的计算开销。

由于，XOR 码编比较简单，便于理解，我们以XOR 码编为例讲解数据恢复原理。

XOR即异或运算，用符号 `^` 表示，是一种二进制位运算符号。两个值相同，异或运算结果为1，两个值不同，结果为0。

- **编码 ( A ^ B = C )**

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652938855452-608f7275-81e3-4182-9f97-18eaa2346e1b.png)

- **解码恢复数据 ( C ^ B = A )**

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652840510351-1ce86e6e-f439-4070-8713-89e643fa34b3.png)

### 2.3 Reed-Solomon码（RS码）

MinIO使用Reed-Solomon码生成数据校验块。

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1658806866035-8b799802-4f29-4f89-b40c-6017d50acee0.png)

Reed-Solomon码可以根据M个数据块，生成N个校验块, 其中 N <= M 。

从 M + N 中取出任意 M 个块就能解码出原始数据。即RS码最多容忍N个块同时丢失。

因此，RS码可以获得更好的磁盘利用率，但是需要更多的计算开销。

举例：假设一共有7块磁盘，允许任意2块硬盘损坏而不丢失数据。100mb大小的文件应如何存储？实际占用多少存储空间？

答案：M + N = 7      N = 2     M = 7 -2 = 5

​           因此，将100mb的文件分割成5份20mb的数据块，利用RS码生成2个20mb的校验块。将数据块和校验块分别存储到不同的硬盘上。

​           实际占用 （ 5 * 20 ）+（ 2 * 20 ）= 140M。

​          ![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1652844558516-9fcfad12-de74-49e1-a5a8-1714f95fd82e.png)



参考资料：

1.存储系统中的纠删码（Erasure Codes）—XOR 码和RS 码

[http://blog.foool.net/2014/05/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f%e4%b8%ad%e7%9a%84%e7%ba%a0%e5%88%a0%e7%a0%81%ef%bc%88erasure-codes%ef%bc%89xor-%e7%a0%81%e5%92%8crs-%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89/](http://blog.foool.net/2014/05/存储系统中的纠删码（erasure-codes）xor-码和rs-码（二）/)

2.异或运算 XOR 教程

https://www.ruanyifeng.com/blog/2021/01/_xor.html

|      |      |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |
|      |      |      |