# 1.对象锁定

**对象锁定（Object Locking）：**对象锁定使用一次写入，多次读取 (WORM) 模式存储对象。可以将对象锁定一段时间，在此期间无法彻底删除。

MinIO官网示例：https://github.com/minio/minio-java/tree/master/examples

注意：1.对象锁定只能在创建bucket时启用。对象锁定会自动启用版本控制功能。

引入依赖

```xml
 <dependency>
   <groupId>io.minio</groupId>
   <artifactId>minio</artifactId>
   <version>8.4.1</version>
</dependency>
```

示例代码

```java
import io.minio.*;
import io.minio.errors.MinioException;
import io.minio.messages.Item;
import io.minio.messages.Retention;
import io.minio.messages.RetentionMode;

import java.time.ZonedDateTime;

public class SetObjectRetention {

    public static void main(String[] args) throws Exception {
        try {
            MinioClient minioClient = MinioClient.builder()
                    .endpoint("http://127.0.0.1:9000")
                    .credentials("minioadmin", "minioadmin")
                    .build();

            String bucketName = "locked-bucket";
            String keyName = "myschool.sql";

            //如果bucket不存在则创建
            if (!minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build())) {
                minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());
                System.out.println(bucketName + " is created successfully");
            }

            //上传对象
            minioClient.uploadObject(UploadObjectArgs.builder()
                    .bucket(bucketName)
                    .object(keyName)
                    .filename("src/myschool.sql")
                    .build());

            //设置保留模式，期限90天
            ZonedDateTime retentionUntil = ZonedDateTime.now(Time.UTC).plusDays(90).withNano(0);
            Retention config = new Retention(RetentionMode.GOVERNANCE, retentionUntil);
            minioClient.setObjectRetention(SetObjectRetentionArgs.builder()
                    .bucket(bucketName)
                    .object(keyName)
                    .config(config)
                    .build());

            // 可以删除对象，逻辑删除，可恢复
            minioClient.removeObject(
                    RemoveObjectArgs.builder()
                            .bucket(bucketName)
                            .object(keyName)
                            .build());
            System.out.println("delete object successfully");

            //查询所有版本
            Iterable<Result<Item>> results = minioClient.listObjects(
                    ListObjectsArgs.builder()
                            .bucket(bucketName)
                            .prefix(keyName)
                            .includeVersions(true)
                            .build());

            //不可以彻底删除，即不能删除对象所有版本
            for (Result<Item> result : results) {
                Item item = result.get();
                System.out.println("delete object , "+ item.lastModified() + "\t" + item.size() + "\t" + item.objectName() + "[" + item.versionId() + "]");
                minioClient.removeObject(
                        RemoveObjectArgs.builder()
                                .bucket(bucketName)
                                .object(keyName)
                                .versionId(item.versionId())
                                .build());
            }

        } catch (MinioException e) {
            System.out.println("delete all versions of the object failed");
//            e.printStackTrace();
        }
    }
}
```

# 2.对象保留模式

## 保留模式

MinIO对象锁定提供两种*保留模式*，这些保留模式对对象应用不同级别的保护。可将任意一种保留模式应用于受对象锁定保护的任意对象版本。

如果没有特殊需求，建议使用监管模式（GOVERNANCE）。

- 监管模式（GOVERNANCE）

在*监管* 模式中，除非用户具有特殊权限，否则用户不能覆盖或删除对象版本，或更改其锁定设置。使用监管模式，您可以保护对象以免被大多数用户删除，但您仍可向部分用户授予在必要时更改保留设置或删除对象的权限。

- 合规性模式 （COMPLIANCE）

在*合规性*模式中，任何用户都不能覆盖或删除受保护的对象版本，包括MinIO的root用户。在合规性模式下锁定对象后，其保留模式便无法更改，其保留期限也不能缩短。合规性模式可帮助确保在保留期限内无法覆盖或删除对象版本。

二者的主要区别在于，在监管模式（GOVERNANCE）下，MinIO的root用户可以清除保留期限设置，而在合规性模式 （COMPLIANCE）则不行。

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1653476418425-c099cc0f-64b8-46b1-9590-7bb6a3da69e8.png)

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1653476470007-e3206604-7af4-473b-b2fc-27e01e4278f2.png)

注意：目前MinIO保留期限只支持以日（d）和年（y）为单位。

# 3.设置bucket默认保留规则

对象锁定功能必须在创建bucket时启动。该功能自动启用版本控制功能。创建bucket后无法启用此功能。

```java
import io.minio.*;
import io.minio.errors.MinioException;
import io.minio.messages.ObjectLockConfiguration;
import io.minio.messages.RetentionDurationDays;
import io.minio.messages.RetentionMode;

public class SetObjectLockConfiguration {

    public static void main(String[] args) throws Exception {

        try {
            MinioClient minioClient = MinioClient.builder()
                    .endpoint("http://127.0.0.1:9000")
                    .credentials("minioadmin", "minioadmin")
                    .build();


            String bucketName = "locked-bucket";
            //如果bucket不存在则创建
            //创建bucket必须启用对象锁定功能，该功能自动启动版本控制功能
            //文件锁定必须在创建时才能启用
            if (!minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build())) {
                minioClient.makeBucket(MakeBucketArgs.builder().
                        bucket(bucketName)
                        .objectLock(true)
                        .build());
                System.out.println(bucketName + " is created successfully");
            }

            //设置bucket默认保留规则
            ObjectLockConfiguration defaultRetentionConf =
                    new ObjectLockConfiguration(RetentionMode.GOVERNANCE, new RetentionDurationDays(100));
            minioClient.setObjectLockConfiguration(
                    SetObjectLockConfigurationArgs.builder()
                            .bucket(bucketName)
                            .config(defaultRetentionConf)
                            .build());
            System.out.println("object-lock configuration is set successfully");

            //查看bucket默认保留规则
            ObjectLockConfiguration config =
                    minioClient.getObjectLockConfiguration(
                            GetObjectLockConfigurationArgs.builder()
                                    .bucket(bucketName)
                                    .build());

            System.out.println("Object-lock configuration of bucket");
            System.out.println("Mode: " + config.mode());
            System.out.println("Duration: " + config.duration());

            //删除bucket默认保留规则
            minioClient.deleteObjectLockConfiguration(
                    DeleteObjectLockConfigurationArgs.builder().bucket(bucketName).build());

            System.out.println("Object-lock configuration is deleted successfully");

        } catch (MinioException e) {
           e.printStackTrace();
        }
    }
}
```

|      |      |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |
|      |      |      |