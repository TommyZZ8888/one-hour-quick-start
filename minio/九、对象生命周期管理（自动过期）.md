# 1.设置过期规则

（1）如果bucket没有启动版本设置，设置`--expiry-days 90`，文件90天之后会被直接被直接删除，不可恢复

（2）如果bucket启动了版本设置，文件90天之后会自动添加一个删除标记（逻辑删除），需要另外设置`--noncurrentversion-expiration-days 30`过期版本的保留期限为30天，相当于文件会被保存120后才会被删除。

```bash
mc ilm add --expiry-days 90 my-minio/version-bucket

#如果bucket启用了版本控制，文件到期之后历史版本会多保留30天
mc ilm add --noncurrentversion-expiration-days 30 my-minio/version-bucket
```

自动过期有多版本信息且被标记为删除的对象，如下图所示

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1653356916434-a0fdba32-7241-4576-8733-0ddec0f55ac2.png)

当对象历史版本都已经被删除，只剩删除标记，通过--expired-object-delete-marker来自动删除对象。

```bash
mc ilm add --expired-object-delete-marker my-minio/version-bucket
import io.minio.MinioClient;
import io.minio.SetBucketLifecycleArgs;
import io.minio.errors.MinioException;
import io.minio.messages.*;
import org.simpleframework.xml.Element;

import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import java.io.IOException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.time.ZonedDateTime;
import java.util.LinkedList;
import java.util.List;

public class SetBucketLifecycle {
    public static void main(String[] args)
            throws IOException, NoSuchAlgorithmException, InvalidKeyException {
        try {
            MinioClient minioClient =
                    MinioClient.builder()
                            .endpoint("http://127.0.0.1:9000")
                            .credentials("minioadmin", "minioadmin")
                            .build();


            List<LifecycleRule> rules = new LinkedList<>();
            rules.add(
                    new LifecycleRule(
                            Status.ENABLED,
                            null,
                            new Expiration((ZonedDateTime) null, 90, null),
                            new RuleFilter(""),
                            "rules-1",
                            null,
                            null,
                            null));

            rules.add(
                    new LifecycleRule(
                            Status.ENABLED,
                            null,
                           null,
                            new RuleFilter(""),
                            "rules-2",
                            new NoncurrentVersionExpiration(30),
                            null,
                            null));

            //如果要设置ExpiredObjectDeleteMarker
            //此处有bug，详见https://github.com/minio/minio-java/pull/1336
//            rules.add(
//                    new LifecycleRule(
//                            Status.ENABLED,
//                            null,
//                            new Expiration(new Boolean(true )),
//                            new RuleFilter(""),
//                            "rules-3",
//                           null,
//                            null,
//                            null));

            LifecycleConfiguration config = new LifecycleConfiguration(rules);

            minioClient.setBucketLifecycle(
                    SetBucketLifecycleArgs.builder().bucket("my-bucket").config(config).build());
        } catch (MinioException e) {
            System.out.println("Error occurred: " + e);
        }
    }
}
```

查看对象自动过期规则

```bash
mc ilm ls my-minio/version-bucket
```

![img](https://cdn.nlark.com/yuque/0/2022/png/28915315/1653357157472-05e498cb-e535-4d5a-812c-1254bffe5f25.png)

删除对象自动过期规则

```bash
mc ilm rm --all --force my-minio/version-bucket
```

|      |      |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |
|      |      |      |